#!/bin/bash

get_repo_dir () {
  SOURCE="${BASH_SOURCE[0]}"
  # While $SOURCE is a symlink, resolve it
  while [ -h "$SOURCE" ]; do
       DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
       SOURCE="$( readlink "$SOURCE" )"
       # If $SOURCE was a relative symlink (so no "/" as prefix, need to resolve
       # it relative to the symlink base directory
       [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
  done
  DIR="$( cd -P "$( dirname "$SOURCE" )/.." && pwd )"
  echo "$DIR"
}

REPO_DIR="$(get_repo_dir)"

CA_CERTS="${REPO_DIR}/test/tls/ca.crt"
CERTFILE="${REPO_DIR}/test/tls/redis.crt"
KEYFILE="${REPO_DIR}/test/tls/redis.key"
REDIS_URL="rediss://localhost:6379?ssl_cert_reqs=required&ssl_ca_certs=${CA_CERTS}&ssl_keyfile=${KEYFILE}&ssl_certfile=${CERTFILE}"

REDIS_URL="$REDIS_URL" make test
